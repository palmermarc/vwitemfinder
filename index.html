<!DOCTYPE html>
<html>
	<head>
		<title>Final Sunset Item Finder</title>
		<style>
			#content { width: 600px; margin: 0 auto; }
			#form { margin: 100px auto; width: 400px; }
			textarea { display: block; height: 200px; margin: 1em 0; width: 100%; }
			.button { background-color: #cc6600; border-radius: 5px; color: #FFF; display: table; font-weight: bold; margin: 0 auto; padding: 5px 10px; text-transform: uppercase; }
			.button:before { content: ""; display: table; height: 0px; clear: both; }
			table { width: 100%; }
			table tbody tr:hover { background-color: #cc6600; color: #fff; }
			#items_needed { display: none; }
			tr.not_found { background-color: red; color: #FFF; }
			.not_found a { color: #fff; }
		</style>
	</head>
	<body>
		<div id="content">
			<div id="form">
				<textarea id="itemlist" name="itemlist"></textarea>
				<div class="button" id="submit_items">Locate Items</div>
			</div>
			<p>Don't see your item? <a href="https://docs.google.com/forms/d/e/1FAIpQLSfUPhuczSur_dLu2_ZkRu1CIr-Y9K91Sv3JAmzIRsNSVEB25A/viewform?usp=sf_link">Add it to the database</a> to help others who are looking for it.</p>
			<div id="items_needed">
				<table cellpadding="3" cellspacing="3" border="">
					<thead>
						<tr>
							<th>item name</th>
							<th>area</th>
							<th>directions</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>
		</div>

		<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script>
			(function($) {
				$("#submit_items").click(function(e){
					e.preventDefault();

          var found_items = [];
          var db = new Dexie("itemfinder");

          db.version(1).stores({
            items: 'name'
          });
					$('#items_needed').hide();
					var lines = $('#itemlist').val().split(/\n/);
					for (var i=0; i < lines.length; i++) {
					  if (/\S/.test(lines[i])) {
						var item_name = $.trim(lines[i]).replace('.', '');
              db.items.get(item_name, function(response) {
                if(response !== null){
                  found_items.push(response.name);
									$('#items_needed tbody').append(
										'<tr>' +
                    '<td>' + response.name+'</td>'+
                    '<td>' + response.carried_by + '</td>'+
                    '<td>' + response.area + '</td>'+
										'</tr>'
									);
								}
							});
              if($.inArray(item_name, found_items) < 0) {
                $('#items_needed tbody').append(
                  '<tr class="not_found">' +
                  '<td>' + item_name+'</td>'+
                  '<td colspan="2"> <a href="https://docs.google.com/forms/d/e/1FAIpQLSfUPhuczSur_dLu2_ZkRu1CIr-Y9K91Sv3JAmzIRsNSVEB25A/viewform?usp=sf_link" target="_blank">NOT FOUND - Add it to the database</a>!</td>' +
                  '</tr>'
                );
              }
					  }
					}
					$('#items_needed').show();
				});
			
			}(jQuery));

      function getItems() {
        var params = {
          spreadsheetId: '1d1gPhOCxrIpuvLMKVZuyeDXBpBdeCm_q-yOZQO_nM6M',
          range: 'Items!B2:E3000',
					majorDimension: 'ROWS'
        };

        var request = gapi.client.sheets.spreadsheets.values.get(params);
        request.then(function(response) {
          if(response.result.values.length) {
            var db = new Dexie("itemfinder");
            db.version(1).stores({
              items: 'name'
            });
            db.items.clear();
            for(var i=0;i<response.result.values.length; i++){
              var item = response.result.values[i];
              db.items.put({name: item[0], carried_by: item[1], area: item[2]})
            }
					}

        }, function(reason) {
          console.error('error: ' + reason.result.error.message);
        });
      }

      function initClient() {
        console.log('initializing');
        var API_KEY = 'AIzaSyA8eUC7tsBoQYJCm2_44V1jm-guy1HRSio';
        var CLIENT_ID = '958556083005-7si1bd2vjh4fsf74hgud0gmldb5scta3.apps.googleusercontent.com';
        var SCOPE = 'https://www.googleapis.com/auth/spreadsheets.readonly';

        gapi.client.init({
          'apiKey': API_KEY,
          'clientId': CLIENT_ID,
          'scope': SCOPE,
          'discoveryDocs': ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
        }).then(function() {
          getItems();
        });
      }

      function handleClientLoad() {
        gapi.load('client:auth2', initClient);
      }
		</script>

		<script async defer src="https://apis.google.com/js/api.js"
						onload="this.onload=function(){};handleClientLoad()"
						onreadystatechange="if (this.readyState === 'complete') this.onload()">
		</script>
	</body>
</html>